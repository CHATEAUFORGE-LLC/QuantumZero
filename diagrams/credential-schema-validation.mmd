sequenceDiagram
  autonumber
  actor Admin as Admin / Issuer
  participant API as Schema Management API
  participant Val as Schema Validator Engine
  participant Store as Schema Registry Store
  participant Cache as Schema Cache
  participant Log as Audit Log

  %% Schema Registration
  Note over Admin,Log: Schema Definition & Registration Phase
  Admin->>API: POST /schemas/register\n(schema definition + metadata)
  API->>Val: Validate schema format\n(JSON Schema / W3C format)
  
  alt Schema is valid
    Val-->>API: Valid schema structure
    API->>Store: Store schema template\n(id, version, type, rules)
    Store-->>API: Schema ID + version
    API->>Cache: Cache schema for fast lookup
    API->>Log: Record schema registration event
    API-->>Admin: 201 Created (Schema ID)
  else Schema has errors
    Val-->>API: Validation errors\n(missing fields, invalid types)
    API->>Log: Record validation failure
    API-->>Admin: 400 Bad Request\n(clear error messages)
  end

  %% Credential Validation
  Note over Admin,Log: Credential Validation Phase
  participant Issuer as Issuer Service
  Issuer->>API: Validate credential against schema\n(credential payload + schema ID)
  API->>Cache: Lookup schema by ID
  
  alt Schema found in cache
    Cache-->>API: Schema definition
  else Schema not in cache
    API->>Store: Fetch schema by ID
    Store-->>API: Schema definition
    API->>Cache: Update cache
  end

  API->>Val: Validate credential structure\n(against schema rules)
  
  par Schema Validation Checks
    Val->>Val: Check required fields
    Val->>Val: Validate field types
    Val->>Val: Verify field constraints
    Val->>Val: Check W3C compliance (context, type)
  end

  alt Credential is valid
    Val-->>API: Validation passed
    API->>Log: Record successful validation
    API-->>Issuer: 200 OK (validation success)
  else Credential has errors
    Val-->>API: Validation errors\n(field: error details)
    API->>Log: Record validation failure\n(error details + credential hash)
    API-->>Issuer: 422 Unprocessable Entity\n(detailed error messages)
  end

  %% Multiple Schema Types Support
  Note over Admin,Val: Supporting Multiple Schema Types
  Admin->>API: List supported schema types
  API-->>Admin: [W3C VC, JSON Schema, Custom Types]

  Note over Val: Schema Types Supported:<br/>- W3C Verifiable Credential<br/>- JSON Schema Draft 7/2020<br/>- AnonCreds Schema<br/>- Custom Schema Extensions

  %% Error Message Examples
  Note over API,Issuer: Error Response Format:<br/>{<br/>  "valid": false,<br/>  "errors": [{<br/>    "field": "credentialSubject.birthDate",<br/>    "error": "Invalid date format",<br/>    "expected": "YYYY-MM-DD"<br/>  }]<br/>}

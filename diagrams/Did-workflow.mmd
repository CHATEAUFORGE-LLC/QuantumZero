sequenceDiagram
  autonumber
  actor U as User
  participant W as QuantumZero Wallet (Holder)
  participant K as Secure Enclave / Android Keystore
  participant D as DID Method Driver (did:key / did:web / did:ion)
  participant R as DID Registry / Resolver (optional)
  participant S as Wallet Storage (encrypted)

  U->>W: Tap "Create DID"
  W->>K: Generate key pair (non-exportable)
  K-->>W: keyRef + publicKey

  W->>D: Build DID from publicKey (method-specific)
  D-->>W: DID (e.g., did:key:..., did:web:...)

  W->>W: Create DID Document (verificationMethod, keyAgreement, services)
  alt Method requires publication (e.g., did:web / did:ion)
    W->>D: Publish DID Document / Create operation
    D->>R: Anchor/Host DID Document (method-specific)
    R-->>D: Publication confirmation / txRef
    D-->>W: Published + txRef
  else Local-only method (e.g., did:key)
    W-->>W: No network publish needed
  end

  W->>S: Store DID, DID Doc, keyRef (encrypted at rest)
  S-->>W: Stored

  note over W,K: Private key never leaves secure hardware

  %% Key Rotation
  U->>W: Rotate DID keys (optional)
  W->>K: Generate new key pair
  K-->>W: newKeyRef + newPublicKey
  W->>W: Update DID Document (add new key, mark old as retired)
  alt Published DID method
    W->>D: Publish update / rotate operation
    D->>R: Update anchored document/operation
    R-->>D: Update confirmation
    D-->>W: Rotation complete
  else Local-only method
    W-->>W: Rotation stored locally
  end
  W->>S: Store updated DID Doc + newKeyRef
  S-->>W: Stored

  %% Deactivation
  U->>W: Deactivate DID (optional)
  alt Published DID method
    W->>D: Publish deactivation operation
    D->>R: Mark DID as deactivated
    R-->>D: Deactivation confirmation
    D-->>W: Deactivated
  else Local-only method
    W-->>W: Mark DID inactive locally
  end
  W->>S: Update status=deactivated
  S-->>W: Saved

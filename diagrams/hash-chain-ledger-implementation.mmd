---
config:
  layout: elk
---
flowchart TB

%% Hash-Chain / Lightweight Ledger Implementation for Tamper-Evident Credential Tracking

subgraph Initialization["Ledger Initialization"]
  Genesis["Genesis Block<br>---<br>Hash: 0x000...000<br>PrevHash: null<br>Timestamp: T0<br>Data: 'Genesis'"]
end

subgraph WriteOperation["Write Operations"]
  direction TB
  
  Event["Credential Event<br>(Issue/Revoke/Update)"]
  
  subgraph BlockCreation["Block Creation Process"]
    direction TB
    Gather["Gather Transaction Data<br>- Event Type<br>- Credential Hash<br>- Issuer DID<br>- Timestamp<br>- Metadata"]
    
    PrevBlock["Fetch Previous Block<br>Get last block hash"]
    
    BuildBlock["Build Block Structure<br>{<br>  index: n,<br>  timestamp: T,<br>  data: event,<br>  prevHash: hash(n-1),<br>  nonce: 0<br>}"]
    
    CalcHash["Calculate Block Hash<br>hash = SHA-256(<br>  index + timestamp +<br>  data + prevHash + nonce<br>)"]
    
    Append["Append to Chain<br>Store block in ledger"]
  end
end

subgraph ReadOperation["Read & Verification Operations"]
  direction TB
  
  Query["Query Credential History<br>GET /ledger/credential/{id}"]
  
  Fetch["Fetch All Related Blocks<br>From ledger storage"]
  
  subgraph Verification["Integrity Verification"]
    direction TB
    VerifyChain["Verify Hash Chain<br>For each block:"]
    CheckHash["1. Recalculate block hash<br>2. Compare with stored hash"]
    CheckLink["3. Verify prevHash<br>matches previous block"]
    CheckIntegrity["4. Detect tampering<br>if any hash mismatch"]
  end
  
  Result["Return Result<br>- Credential history<br>- Integrity status<br>- Tamper alerts"]
end

subgraph Storage["Storage Layer"]
  direction LR
  
  BlockStore[("Block Storage<br>PostgreSQL / MongoDB<br>---<br>Block Schema:<br>- index (unique)<br>- timestamp<br>- data (JSON)<br>- hash (indexed)<br>- prevHash<br>- nonce")]
  
  Index[("Hash Index<br>Fast lookups by:<br>- Block hash<br>- Credential hash<br>- Issuer DID<br>- Timestamp range")]
  
  Backup[("Backup & Archive<br>Periodic snapshots<br>Immutable archive<br>Disaster recovery")]
end

subgraph TamperDetection["Tamper Detection System"]
  direction TB
  
  Monitor["Integrity Monitor<br>Periodic verification"]
  
  Audit["Audit Scanner<br>Background verification<br>of entire chain"]
  
  Alert["Alert System<br>Notify on:<br>- Hash mismatch<br>- Missing blocks<br>- Invalid chain"]
end

subgraph Performance["Performance Optimizations"]
  direction LR
  
  Batch["Batch Processing<br>Group multiple events<br>into single block"]
  
  Cache["Merkle Tree Cache<br>Efficient subtree<br>verification"]
  
  Parallel["Parallel Verification<br>Multi-threaded<br>hash checking"]
end

subgraph API["Ledger API"]
  direction TB
  
  Write["POST /ledger/append<br>Add credential event"]
  Read["GET /ledger/credential/{id}<br>Get credential history"]
  Verify["GET /ledger/verify<br>Verify chain integrity"]
  Stats["GET /ledger/stats<br>Ledger statistics"]
end

%% Flow Connections
Genesis ==> PrevBlock

Event --> Gather
Gather --> PrevBlock
PrevBlock --> BuildBlock
BuildBlock --> CalcHash
CalcHash --> Append
Append --> BlockStore

BlockStore --> Index
BlockStore --> Backup

Query --> Fetch
Fetch --> BlockStore
BlockStore --> VerifyChain
VerifyChain --> CheckHash
CheckHash --> CheckLink
CheckLink --> CheckIntegrity
CheckIntegrity --> Result

Monitor --> Audit
Audit --> VerifyChain
CheckIntegrity -.Tamper Detected.-> Alert

API --> WriteOperation
API --> ReadOperation

Batch -.Optimization.-> Append
Cache -.Optimization.-> Verification
Parallel -.Optimization.-> VerifyChain

%% Detailed Block Structure
BlockStructure["Block Structure Detail:<br>---<br>{<br>  index: 12345,<br>  timestamp: '2026-01-09T12:00:00Z',<br>  data: {<br>    eventType: 'ISSUE',<br>    credentialHash: '0xabc...',<br>    issuerDID: 'did:key:z6Mk...',<br>    subjectDID: 'did:key:z6Mk...',<br>    schemaId: 'schema:v1',<br>    metadata: {...}<br>  },<br>  hash: '0x4f5d8a...',<br>  prevHash: '0x3e4c7b...',<br>  nonce: 0<br>}"]

HashCalc["Hash Calculation:<br>---<br>hash = SHA-256(<br>  index +<br>  timestamp +<br>  JSON.stringify(data) +<br>  prevHash +<br>  nonce<br>)<br><br>Result: 64-char hex string"]

TamperExample["Tamper Detection Example:<br>---<br>Original Block 100:<br>  hash: 0xabc123...<br><br>If data modified:<br>  Recalculated: 0xdef456...<br>  Stored: 0xabc123...<br>  [ERROR] MISMATCH DETECTED<br><br>If Block 99 modified:<br>  Block 100 prevHash invalid<br>  [ERROR] CHAIN BREAK DETECTED"]

BlockStructure -.-> BuildBlock
HashCalc -.-> CalcHash
TamperExample -.-> CheckIntegrity

%% Performance Metrics
PerfMetrics["Performance Targets:<br>---<br>- Write: < 50ms per block<br>- Read: < 100ms<br>- Verify: < 200ms per 1000 blocks<br>- Storage: ~1KB per block<br>- Throughput: 1000+ TPS"]

PerfMetrics -.-> Performance

%% Styling
classDef init fill:#e3f2fd,stroke:#0277bd
classDef write fill:#fff3e0,stroke:#e65100
classDef read fill:#f3e5f5,stroke:#6a1b9a
classDef storage fill:#e8f5e9,stroke:#2e7d32
classDef detect fill:#ffebee,stroke:#c62828
classDef perf fill:#fce4ec,stroke:#ad1457

class Initialization,Genesis init
class WriteOperation,Event,BlockCreation,Gather,PrevBlock,BuildBlock,CalcHash,Append write
class ReadOperation,Query,Fetch,Verification,VerifyChain,CheckHash,CheckLink,CheckIntegrity,Result read
class Storage,BlockStore,Index,Backup storage
class TamperDetection,Monitor,Audit,Alert detect
class Performance,Batch,Cache,Parallel perf
---
title: Sequence Diagram - Mobile Biometric Authentication
config:
  theme: base
---
sequenceDiagram
    autonumber
    participant User
    participant App as Flutter App
    participant Plugin as local_auth
    participant OS as OS Secure Module

    Note over User, OS: RESILIENT MODE (With PIN Fallback)

    User->>App: Opens Sensitive Feature
    activate App
    
    App->>Plugin: authenticate(biometricOnly: false)
    activate Plugin
    
    Plugin->>OS: Trigger Biometric Prompt
    activate OS
    
    OS->>User: Scan Face/Finger

    alt Match Success
        User->>OS: Scans Valid Biometric
        OS-->>Plugin: Success
        Plugin-->>App: true (Authenticated)
        App->>User: Grant Access
    else Match Failed (User Retry)
        User->>OS: Scans Invalid Biometric
        OS-->>User: "Try Again" Animation
        Note right of OS: OS stays active (waiting)
    else Fallback to PIN
        User->>OS: Selects "Use PIN"
        OS->>User: Prompt Device Passcode
        
        alt PIN Correct
            User->>OS: Enters Valid PIN
            OS-->>Plugin: Success
            deactivate OS
            Plugin-->>App: true (Authenticated)
            deactivate Plugin
            App->>User: Grant Access
            deactivate App
        else PIN Wrong
            activate OS
            OS-->>Plugin: Error (AuthFailed)
            deactivate OS
            activate Plugin
            Plugin-->>App: false (Denied)
            deactivate Plugin
            activate App
            App->>User: Show Error Message
            deactivate App
        end
    end
---
title: Sequence Diagram - Server Credential Signing
config:
  theme: base
---
sequenceDiagram
  autonumber
  actor Issuer as Issuer System
  participant API as Issuer Signing API
  participant VC as VC Builder (W3C)
  participant CAN as Canonicalizer\n(JSON-LD / JWT)
  participant KMS as Key Manager
  participant HSM as HSM / Secure Key Store
  participant DB as Issuer Store
  participant LOG as Audit / Metrics

  Issuer->>API: POST /credentials/issue\n(payload + subject DID)
  API->>VC: Build VC structure\n@context, type, issuer, credentialSubject, issuanceDate
  VC-->>API: Unsigned VC

  API->>CAN: Prepare signing input\n(JSON-LD canonicalize OR JWT claims)
  CAN-->>API: Signing payload bytes

  API->>KMS: Select key + signature suite\n(by credential type / policy)
  KMS->>HSM: Sign payload (non-exportable key)
  Note over HSM: Private key never leaves HSM
  HSM-->>KMS: Signature
  KMS-->>API: Signature + verificationMethod

  API->>VC: Attach W3C proof\n(type, created, verificationMethod,\nproofPurpose, proofValue/JWS)
  VC-->>API: Signed VC

  API->>DB: Store VC hash + metadata
  API->>LOG: Log issuance (latency, suite, issuer)
  API-->>Issuer: 201 Created + Signed VC

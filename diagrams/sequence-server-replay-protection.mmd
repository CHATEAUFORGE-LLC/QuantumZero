---
title: Sequence Diagram - Server Replay Protection
config:
  theme: base
---
%% QuantumZero UML palette note: actors/external=#fff7e6/#b45309, system/component=#e0f2fe/#075985, datastore=#ecfccb/#4d7c0f, notes=#fff9c4/#d97706. Aligns diagrams to Deliverable 1 UML/DFD theme.
sequenceDiagram
  autonumber
  participant Wallet as Holder Wallet
  participant API as Verification API
  participant Store as Nonce Store (PostgreSQL)

  %% Step 1: Challenge
  Wallet->>API: initiateVerification()
  activate API
  API->>API: generateRandomNonce()
  API->>Store: save(nonce, expiry=TTL)
  activate Store
  Store-->>API: success
  deactivate Store
  API-->>Wallet: return { challenge: nonce }
  deactivate API

  %% Step 2: Response
  Wallet->>Wallet: generateProof(credentials, challenge=nonce)
  Wallet->>API: submitProof(vp, nonce, timestamp)
  activate API

  %% Step 3: Validation
  API->>API: checkTimestamp(timestamp)
  alt Timestamp outside TTL
    API-->>Wallet: Error: Request Expired
  else Timestamp Valid
    API->>Store: getAndDelete(nonce)
    activate Store
    Store-->>API: result (found/null)
    deactivate Store
    alt Nonce Found
      API->>API: verifyProof(vp)
      API-->>Wallet: Success: Valid & Fresh
    else Nonce Not Found / Used
      API-->>Wallet: Error: Replay Detected
    end
  end
  deactivate API

sequenceDiagram
  autonumber
  actor User as User
  participant UI as Mobile App UI
  participant Wallet as Wallet Manager
  participant DIDGen as DID Generation Service
  participant KeyStore as Secure Key Storage<br>(Keychain/Keystore)
  participant Crypto as Cryptographic Library<br>(DIDKit/Aries)
  participant Validator as W3C Compliance Validator
  participant Storage as Local Encrypted Storage<br>(SQLite)
  participant Network as DID Registry<br>(Optional: did:web/did:ion)

  Note over User,Network: DID Generation Workflow with W3C Compliance & Secure Storage

  %% Initialization
  User->>UI: Tap "Create Identity"
  UI->>Wallet: initiateDIDCreation()
  Wallet->>DIDGen: generateDID(options)
  
  Note over DIDGen: Options:<br/>- DID Method (did:key/did:web/did:ion)<br/>- Key Type (Ed25519/secp256k1)<br/>- Hardware-backed: true

  %% Performance Requirement Check
  rect rgb(255, 248, 220)
    Note over DIDGen,KeyStore: Performance Target: < 1s total
  end

  %% Step 1: Key Generation (Secure Hardware)
  DIDGen->>KeyStore: generateKeyPair(algorithm, hardwareBacked=true)
  
  rect rgb(240, 248, 255)
    Note over KeyStore: Hardware-Backed Key Generation:<br/>iOS: Secure Enclave (kSecAttrTokenIDSecureEnclave)<br/>Android: StrongBox/TEE (setIsStrongBoxBacked)
    KeyStore->>KeyStore: Generate key pair in secure hardware
    Note over KeyStore: Private key properties:<br/>- Non-exportable (kSecAttrIsExtractable: false)<br/>- Hardware-bound<br/>- Biometric-protected (optional)<br/>- Attestation available
  end
  
  KeyStore-->>DIDGen: {keyId, publicKey, keyMetadata}
  
  Note over DIDGen: Key Generation Time: ~200-400ms

  %% Step 2: DID Construction (W3C Compliant)
  DIDGen->>Crypto: constructDID(publicKey, method)
  
  rect rgb(245, 255, 250)
    Note over Crypto: DID Method Construction:<br/><br/>did:key (default):<br/>  did:key:z6Mk + base58(publicKey)<br/><br/>did:web:<br/>  did:web:domain.com:user:alice<br/><br/>did:ion:<br/>  did:ion:EiD... (ION operation)
    
    Crypto->>Crypto: Encode public key (multibase)
    Crypto->>Crypto: Generate DID string
  end
  
  Crypto-->>DIDGen: didString (e.g., did:key:z6Mk...)
  
  %% Step 3: DID Document Creation (W3C Standard)
  DIDGen->>Crypto: createDIDDocument(didString, publicKey, keyId)
  
  rect rgb(255, 245, 255)
    Note over Crypto: W3C DID Document Structure:<br/>{<br/>  "@context": [<br/>    "https://www.w3.org/ns/did/v1",<br/>    "https://w3id.org/security/suites/ed25519-2020/v1"<br/>  ],<br/>  "id": "did:key:z6Mk...",<br/>  "verificationMethod": [{<br/>    "id": "did:key:z6Mk...#z6Mk...",<br/>    "type": "Ed25519VerificationKey2020",<br/>    "controller": "did:key:z6Mk...",<br/>    "publicKeyMultibase": "z6Mk..."<br/>  }],<br/>  "authentication": ["did:key:z6Mk...#z6Mk..."],<br/>  "assertionMethod": ["did:key:z6Mk...#z6Mk..."],<br/>  "keyAgreement": [...],<br/>  "capabilityInvocation": [...],<br/>  "capabilityDelegation": [...]<br/>}
    
    Crypto->>Crypto: Build verificationMethod
    Crypto->>Crypto: Add authentication relationship
    Crypto->>Crypto: Add assertionMethod relationship
    Crypto->>Crypto: Add keyAgreement (optional)
  end
  
  Crypto-->>DIDGen: didDocument (W3C compliant)

  %% Step 4: W3C Compliance Validation
  DIDGen->>Validator: validateDIDDocument(didDocument)
  
  rect rgb(255, 250, 240)
    Note over Validator: W3C Compliance Checks:<br/>✓ Required @context present<br/>✓ Valid DID syntax (ABNF grammar)<br/>✓ verificationMethod structure<br/>✓ Relationship properties valid<br/>✓ Key material format correct<br/>✓ Controller references valid<br/>✓ No conflicting properties
    
    Validator->>Validator: Validate @context URIs
    Validator->>Validator: Validate DID syntax (regex)
    Validator->>Validator: Validate verificationMethod array
    Validator->>Validator: Validate key format (multibase)
    Validator->>Validator: Check relationship references
  end
  
  alt W3C Validation Passed
    Validator-->>DIDGen: [VALID] W3C DID Document
  else Validation Failed
    Validator-->>DIDGen: [ERROR] Validation Errors
    DIDGen-->>Wallet: Error: Invalid DID Document
    Wallet-->>UI: Display error message
    UI-->>User: "DID creation failed"
    Note over User,Network: Abort and retry
  end

  Note over DIDGen: Validation Time: ~50-100ms

  %% Step 5: Optional Network Registration
  alt DID Method Requires Publication (did:web, did:ion)
    DIDGen->>Network: publishDIDDocument(didDocument)
    
    rect rgb(248, 255, 248)
      Note over Network: Publication Methods:<br/><br/>did:web:<br/>  HTTPS PUT to /.well-known/did.json<br/><br/>did:ion:<br/>  Submit create operation to ION node<br/>  Wait for anchoring confirmation
    end
    
    Network-->>DIDGen: Publication confirmation
    Note over DIDGen: Network Time: ~200-500ms (if required)
  else Local-only DID (did:key)
    Note over DIDGen: No publication needed<br/>did:key is self-certifying
  end

  %% Step 6: Secure Storage
  DIDGen->>Storage: storeDIDMetadata(didData)
  
  rect rgb(255, 245, 238)
    Note over Storage: Encrypted Storage Structure:<br/>{<br/>  did: "did:key:z6Mk...",<br/>  keyId: "keychain-ref-123",<br/>  didDocument: {...},<br/>  method: "did:key",<br/>  created: "2026-01-09T12:00:00Z",<br/>  keyType: "Ed25519",<br/>  hardwareBacked: true,<br/>  publicKey: "z6Mk...",<br/>  metadata: {<br/>    alias: "My Identity",<br/>    purpose: "authentication"<br/>  }<br/>}<br/><br/>Encryption: AES-256-GCM<br/>Key Derivation: PBKDF2 from device credential
  end
  
  Storage->>Storage: Encrypt DID data
  Storage->>Storage: Store in SQLite
  Storage-->>DIDGen: Storage confirmation
  
  Note over Storage: Storage Time: ~50-100ms

  %% Step 7: Generate Test Signature (Verification)
  DIDGen->>KeyStore: signTestMessage(keyId, "verification-test")
  KeyStore->>KeyStore: Sign with private key (hardware)
  KeyStore-->>DIDGen: signature
  
  DIDGen->>Crypto: verifySignature(publicKey, message, signature)
  
  alt Signature Valid
    Crypto-->>DIDGen: [VALID] Signature verified
    Note over DIDGen: Key pair functional
  else Signature Invalid
    Crypto-->>DIDGen: [ERROR] Verification failed
    DIDGen-->>Wallet: Error: Key verification failed
    Note over User,Network: Critical error - cleanup and retry
  end

  Note over DIDGen: Verification Time: ~20-50ms

  %% Step 8: Unit Tests Validation
  rect rgb(240, 255, 255)
    Note over DIDGen: Automated Unit Tests:<br/>- Key generation successful<br/>- DID format correct<br/>- DID document W3C compliant<br/>- Key is hardware-backed<br/>- Key is non-exportable<br/>- Signature verification works<br/>- Storage encryption valid<br/>- Total time < 1s
  end

  %% Step 9: Return Result
  DIDGen-->>Wallet: {did, didDocument, keyId, created}
  Wallet-->>UI: DID Created Successfully
  
  rect rgb(240, 255, 240)
    UI-->>User: Display Success<br/>"Identity Created"<br/>DID: did:key:z6Mk...<br/>Status: [OK] Secure & Verified
  end

  %% Performance Summary
  rect rgb(255, 248, 220)
    Note over User,Network: Total Performance:<br/>Key Gen: 200-400ms<br/>DID Creation: 50-100ms<br/>Validation: 50-100ms<br/>Network: 0-500ms (optional)<br/>Storage: 50-100ms<br/>Verification: 20-50ms<br/>---<br/>Total: 370-1150ms<br/>[OK] Meets <1s requirement (offline)
  end

  %% Audit Log
  DIDGen->>Storage: logAuditEvent(event)
  Note over Storage: Audit Log Entry:<br/>{<br/>  event: "DID_CREATED",<br/>  did: "did:key:z6Mk...",<br/>  timestamp: "2026-01-09T12:00:00Z",<br/>  method: "did:key",<br/>  keyType: "Ed25519",<br/>  hardwareBacked: true,<br/>  duration: 450ms<br/>}

  %% Styling
  rect rgb(255, 240, 245)
    Note over User,Network: Security Guarantees:<br/>- Private key never leaves hardware<br/>- Non-exportable keys enforced<br/>- W3C standards compliant<br/>- Hardware attestation available<br/>- Encrypted at rest<br/>- Tamper-evident audit log
  end


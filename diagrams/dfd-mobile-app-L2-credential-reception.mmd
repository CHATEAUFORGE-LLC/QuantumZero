---
title: DFD Level 2 - Mobile Credential Reception Process
config:
  theme: base
---
%% DFD Level 2: Detailed credential issuance/reception flow.
flowchart TB
    %% DFD styling
    classDef external fill:#fff2cc,stroke:#111111,stroke-width:1.5px
    classDef process fill:#fff2cc,stroke:#111111,stroke-width:1.5px
    classDef datastore fill:#fff2cc,stroke:#111111,stroke-width:1.5px

    %% External Entities
    Holder["Mobile User<br>(Credential Holder)"]:::external
    Issuer["Issuer Service<br>(QR/API)"]:::external

    %% Processes
    P3_1(["3.1<br>Scan Offer<br>QR Code"]):::process
    P3_2(["3.2<br>Parse Offer<br>Data"]):::process
    P3_3(["3.3<br>Display Offer<br>to User"]):::process
    P3_4(["3.4<br>Generate<br>Credential Request"]):::process
    P3_5(["3.5<br>Receive<br>Credential"]):::process
    P3_6(["3.6<br>Validate<br>Credential"]):::process
    P3_7(["3.7<br>Store<br>Credential"]):::process

    %% Data Stores
    D1[("D1: dids<br>(local SQLite)")]:::datastore
    D2[("D2: credentials<br>(local SQLite)")]:::datastore
    D3[("D3: keys<br>(secure storage)")]:::datastore

    %% Credential Reception Flow
    Holder -->|"scan QR"| P3_1
    P3_1 -->|"raw QR data"| P3_2
    Issuer -->|"credential offer<br>(QR encoded)"| P3_1

    P3_2 -->|"parsed offer"| P3_3
    P3_3 -->|"offer details<br>issuer info<br>credential type"| Holder

    Holder -->|"accept offer"| P3_4
    Holder -->|"reject offer"| P3_3
    P3_3 -->|"cancelled"| Holder

    D1 -.->|"holder DID"| P3_4
    D3 -.->|"signing key"| P3_4
    P3_4 -->|"credential request<br>(signed)"| P3_5
    P3_5 -->|"credential request"| Issuer

    Issuer -->|"signed credential"| P3_5
    P3_5 -->|"raw credential"| P3_6

    P3_6 -->|"signature validation"| P3_6
    P3_6 -->|"invalid credential"| Holder
    P3_6 -->|"valid credential"| P3_7

    P3_7 -->|"credential record"| D2
    P3_7 -->|"success notification"| Holder

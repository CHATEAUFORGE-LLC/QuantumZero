---
config:
  layout: elk
---
flowchart TB

%% =========================
%% Core Idea:
%% - Indy Ledger stores verification primitives (NYM/SCHEMA/CRED_DEF/REVOCATION)
%% - Trusted Registry DB stores descriptive + policy + admin metadata
%% - Optional Ledger Observer indexes ledger for fast lookups and offline cache exports
%% =========================

subgraph Cloud_Infra["QuantumZero Trusted Ledger"]
  direction TB

  Gateway["API Gateway<br>TLS Termination + AuthZ + Rate Limit"]

  subgraph Core_Services["Microservices (Policy + Workflows)"]
    direction LR
    IssuerSvc["<b>Issuance Service</b><br>Creates/Issues VCs<br>Writes ledger artifacts (if needed)"]
    VerifierSvc["<b>Verification Service</b><br>Verifies proofs + signatures<br>Checks revocation every time"]
    RevocationSvc["<b>Revocation Service</b><br>Maintains revocation state<br>Writes revocation updates"]
    AuditSvc["<b>Audit / Admin Logs API</b><br>Structured JSON events"]
  end

  subgraph TrustPlane["Trust Plane (Off-ledger)"]
    direction TB
    TrustDB[("Trusted Registry DB<br>Issuer metadata + policies<br>Credential templates<br>Allowed schema/cred-def<br>Admin config + backups")]
    CachePkg["Offline Trust Cache Exporter<br>Builds signed cache packages<br>for mobile offline verification"]
  end

  subgraph LedgerPlane["Trusted Ledger (Indy Pool)"]
    direction TB

    subgraph Pool["Indy Validator Pool (Local)"]
      direction LR
      N1["Node1"]
      N2["Node2"]
      N3["Node3"]
      N4["Node4"]
    end

    LedgerArtifacts[("On-ledger Artifacts<br>NYM (did:indy)<br>SCHEMA<br>CRED_DEF<br>REV_REG_DEF + REV_REG_ENTRY")]
  end

  subgraph Observer["Optional: Ledger Observer / Indexer"]
    direction TB
    Obs["Ledger Observer<br>Reads ledger updates"]
    LedgerIndex[("Ledger Index / Read Cache<br>Resolved DID keys<br>Schema/CredDef snapshots<br>Revocation snapshots")]
  end

  %% Wiring
  Gateway --> IssuerSvc
  Gateway --> VerifierSvc
  Gateway --> RevocationSvc
  Gateway --> AuditSvc

  %% Services consult Trust Registry policies/metadata
  IssuerSvc --> TrustDB
  VerifierSvc --> TrustDB
  RevocationSvc --> TrustDB

  %% Services read/write ledger via Indy client libraries (not HTTP to ledger)
  IssuerSvc --> Pool
  RevocationSvc --> Pool
  VerifierSvc --> Pool

  %% Ledger produces public verification artifacts
  Pool --> LedgerArtifacts

  %% Optional observer/indexer for fast reads & offline cache generation
  Pool --> Obs
  Obs --> LedgerIndex

  VerifierSvc --> LedgerIndex
  CachePkg --> LedgerIndex
  CachePkg --> TrustDB

  %% Audit events
  IssuerSvc --> AuditSvc
  VerifierSvc --> AuditSvc
  RevocationSvc --> AuditSvc
  AuditSvc --> TrustDB
end

%% =========================
%% Mobile usage of Offline Cache (ties to offline verification requirement)
%% =========================
subgraph Mobile["Mobile Wallet"]
  direction TB
  Wallet["Wallet App<br>(did:indy holder)"]
  OfflineCache["Signed Offline Trust Cache<br>(revocation snapshots + trusted issuers + templates)"]
end

CachePkg --> OfflineCache
OfflineCache --> Wallet

classDef cloud fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
classDef database fill:#e0f2f1,stroke:#004d40,stroke-width:2px
classDef ledger fill:#fff3e0,stroke:#e65100,stroke-width:2px
classDef optional fill:#ede7f6,stroke:#311b92,stroke-width:2px,stroke-dasharray: 5 5
classDef mobile fill:#e1f5fe,stroke:#01579b,stroke-width:2px

class Gateway,IssuerSvc,VerifierSvc,RevocationSvc,AuditSvc cloud
class TrustDB,LedgerIndex database
class Pool,LedgerArtifacts ledger
class Obs,CachePkg optional
class Wallet,OfflineCache mobile
